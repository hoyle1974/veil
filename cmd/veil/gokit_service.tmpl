package {{.PackageName}}


import (
    "context"
    "github.com/hoyle1974/veil/veil"
	"github.com/hoyle1974/veil/veil_internal"
    httptransport "github.com/go-kit/kit/transport/http"
{{range .Packages}}     "{{.}}"
{{end}}
)

{{range .Structs}}
{{ $struct := . }}


// This is an interface that defines the publically exposed methods for the struct '{{.Name}}'
type {{.InterfaceName}} interface {
{{range .Methods}}
    {{.Name}}(ctx context.Context{{range .Args}}, {{.Name}} {{.Type}}{{end}}) ({{range $index, $element := .Returns}}{{if $index}},{{end}}{{$element}}{{end}}){{end}}
}

type {{.RPCName}} struct {
    service *{{.Name}}
}
func (r *{{.RPCName}}) Get() *{{.Name}} {
	return r.service
}
func (r *{{$struct.RPCName}}) RPC_Bind_Service(service any) error {
    s, ok := service.(*{{.Name}})
    if !ok {
        return errors.New("not supported service")
    }
    r.service = s
    return nil
}

{{ $struct = . }}
{{range .Methods}}

// Request Object
type {{$struct.Name}}_{{.Name}}_Request struct { {{range .Args}}
    {{title .Name}} {{.Type}}{{end}}
}

type {{$struct.Name}}_{{.Name}}_Response struct { {{range $index, $type := .Returns}}
    Arg{{$index}} {{$type}}{{end}}
}

func (r *{{$struct.RPCName}}) {{.Name}}(ctx context.Context, request *{{$struct.Name}}_{{.Name}}_Request, reply *[]any) error {
	return nil
}

func encode{{$struct.Name}}_{{.Name}}_Response(_ context.Context, w http.ResponseWriter, response interface{}) error {
	return json.NewEncoder(w).Encode(response)
}

func decode{{$struct.Name}}_{{.Name}}_Request(_ context.Context, r *http.Request) (interface{}, error) {
	var request {{$struct.Name}}_{{.Name}}_Request
	if err := json.NewDecoder(r.Body).Decode(&request); err != nil {
		return nil, err
	}
	return request, nil
}

func decode{{$struct.Name}}_{{.Name}}_Response(_ context.Context, r *http.Response) (interface{}, error) {
	var request {{$struct.Name}}_{{.Name}}_Response
	if err := json.NewDecoder(r.Body).Decode(&request); err != nil {
		return nil, err
	}
	return request, nil
}

type {{$struct.Name}}_Container interface {
	Get() *{{$struct.Name}}
}

func make_{{$struct.Name}}_{{.Name}}_Endpoint(svcContainer {{$struct.Name}}_Container) endpoint.Endpoint {
	return func(_ context.Context, request interface{}) (interface{}, error) {
		svc := svcContainer.Get()
		req := request.({{$struct.Name}}_{{.Name}}_Request)
		{{range $index,$return := .Returns}}{{if $index}},{{end}}arg{{$index}}{{end}} := svc.{{.Name}}(context.Background(){{range $index,$arg := .Args}},req.{{title $arg.Name}}{{end}})
		return {{$struct.Name}}_{{.Name}}_Response{ {{range $index,$return := .Returns}}{{if $index}},{{end}}arg{{$index}}{{end}} }, arg{{ lastItemIndex .Returns }}
	}
}
{{end}}


{{end}}


func init() {

	veil_internal.RegisterServerInit(func() {
{{range .Structs}}
			{{$struct := . }}
            r := &{{.RPCName}}{}
            veil_internal.RegisterService(r)

			{{range .Methods}}
			// Great method handlers
			{{$struct.Name}}_{{.Name}}_Handler := httptransport.NewServer(
				make_{{$struct.Name}}_{{.Name}}_Endpoint(r),
				decode{{$struct.Name}}_{{.Name}}_Request,
				encode{{$struct.Name}}_{{.Name}}_Response,
			)
			http.Handle("/{{$struct.Name}}/{{.Name}}", {{$struct.Name}}_{{.Name}}_Handler)
			{{end}}

{{end}}
    }) // RegisterServerInit
} //init